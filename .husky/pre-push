echo "ğŸš€ Running pre-push checks..."

# Docker í™•ì¸
if ! command -v docker &> /dev/null; then
    echo "âš ï¸ Docker not found. Skipping E2E tests."
    echo "   Install Docker to enable pre-push E2E testing."
    exit 0
fi

# ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
echo "ğŸ§¹ Cleaning up existing processes..."
lsof -ti:3000 | xargs kill -9 2>/dev/null || true

# Firebase Emulator ì‹œì‘
echo "ğŸ”¥ Starting Firebase Emulator..."
npm run emulator:start || exit 1

# Emulator ì¤€ë¹„ ëŒ€ê¸°
echo "â³ Waiting for Emulator to be ready..."
sleep 15

# ì„œë²„ ë¹Œë“œ ë° ì‹œì‘
echo "ğŸ—ï¸ Building application..."
npm run build || {
    npm run emulator:stop
    exit 1
}

echo "ğŸŒ Starting server..."
FIRESTORE_EMULATOR_HOST=localhost:8080 npm start &
SERVER_PID=$!
sleep 5

# E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
echo "ğŸ§ª Running E2E tests..."
FIRESTORE_EMULATOR_HOST=localhost:8080 npx playwright test
TEST_RESULT=$?

# ì •ë¦¬
echo "ğŸ›‘ Cleaning up..."
kill $SERVER_PID 2>/dev/null || true
npm run emulator:stop

if [ $TEST_RESULT -ne 0 ]; then
    echo "âŒ E2E tests failed. Push aborted."
    exit 1
fi

echo "âœ… Pre-push checks passed!"
