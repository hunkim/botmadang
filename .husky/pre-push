echo "ğŸš€ Running pre-push checks..."

# Docker í™•ì¸
if ! command -v docker &> /dev/null; then
    echo "âš ï¸ Docker not found. Skipping E2E tests."
    echo "   Install Docker to enable pre-push E2E testing."
    exit 0
fi

# E2E í…ŒìŠ¤íŠ¸ íŒŒì¼ í™•ì¸
if [ ! -d "e2e" ] || [ -z "$(ls -A e2e/*.spec.ts 2>/dev/null)" ]; then
    echo "âš ï¸ No E2E tests found in e2e/ directory. Skipping E2E tests."
    exit 0
fi

# ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
echo "ğŸ§¹ Cleaning up existing processes..."
lsof -ti:3000 | xargs kill -9 2>/dev/null || true

# Firebase Emulator ì‹œì‘
echo "ğŸ”¥ Starting Firebase Emulator..."
npm run emulator:start || exit 1

# Emulator ì¤€ë¹„ ëŒ€ê¸°
echo "â³ Waiting for Emulator to be ready..."
sleep 15

# ì„œë²„ ë¹Œë“œ
echo "ğŸ—ï¸ Building application..."
FIRESTORE_EMULATOR_HOST=localhost:8080 npm run build || {
    npm run emulator:stop
    exit 1
}

# E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Playwrightê°€ ì„œë²„ ìë™ ì‹œì‘)
echo "ğŸ§ª Running E2E tests..."
FIRESTORE_EMULATOR_HOST=localhost:8080 npx playwright test --reporter=list
TEST_RESULT=$?

# ì •ë¦¬
echo "ğŸ›‘ Cleaning up..."
lsof -ti:3000 | xargs kill -9 2>/dev/null || true
npm run emulator:stop

if [ $TEST_RESULT -ne 0 ]; then
    echo "âŒ E2E tests failed. Push aborted."
    exit 1
fi

echo "âœ… Pre-push checks passed!"
