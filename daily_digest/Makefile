.PHONY: setup run run-date run-loop test clean fetch-only test-connection

VENV := .venv
PYTHON := $(VENV)/bin/python
PIP := $(VENV)/bin/pip

setup:
	python3 -m venv $(VENV)
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt

run:
	$(PYTHON) -m src.main

# tmuxì—ì„œ ë§¤ì¼ ì˜¤ì „ 7ì‹œ(KST) ìë™ ì‹¤í–‰
run-loop:
	@echo "ğŸ”„ ë‹¤ì´ì œìŠ¤íŠ¸ ë£¨í”„ ì‹œì‘ (ë§¤ì¼ KST 07:00, Ctrl+Cë¡œ ì¤‘ì§€)"
	@while true; do \
		NOW=$$(TZ=Asia/Seoul date +%s); \
		TARGET=$$(TZ=Asia/Seoul date -d "tomorrow 07:00" +%s 2>/dev/null || TZ=Asia/Seoul date -v+1d -v7H -v0M -v0S +%s); \
		WAIT=$$((TARGET - NOW)); \
		if [ $$WAIT -gt 86400 ]; then WAIT=$$((WAIT - 86400)); fi; \
		echo "ğŸ’¤ ë‹¤ìŒ ì‹¤í–‰: KST 07:00 ($$((WAIT/3600))ì‹œê°„ $$((WAIT%3600/60))ë¶„ í›„)"; \
		sleep $$WAIT; \
		echo "â° $$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST') ë‹¤ì´ì œìŠ¤íŠ¸ ì‹¤í–‰"; \
		$(PYTHON) -m src.main --skip-eval --send-email || true; \
	done

# íŠ¹ì • ë‚ ì§œë¡œ ì‹¤í–‰ (ì˜ˆ: make run-date DATE=2026-02-05)
run-date:
	$(PYTHON) -m src.main --date $(DATE)

# í¬ìŠ¤íŠ¸ ìˆ˜ì§‘ë§Œ í…ŒìŠ¤íŠ¸
fetch-only:
	$(PYTHON) -m src.main --fetch-only

# Firebase ì—°ê²° í…ŒìŠ¤íŠ¸
test-connection:
	$(PYTHON) -m src.main --test-connection

test:
	$(PYTHON) -m pytest tests/ -v

clean:
	rm -rf $(VENV) __pycache__ .pytest_cache src/__pycache__
